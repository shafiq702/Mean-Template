'use strict';

var app = angular.module('main', ['ui.router', 'textAngular']);

app.config(function ($urlRouterProvider, $locationProvider) {
  // This turns off hashbang urls (/#about) and changes it to something normal (/about)
  // $locationProvider.html5Mode(true);
  // If we go to a URL that ui-router doesn't have registered, go to the "/" url.
  $urlRouterProvider.otherwise('/');
});

app.run(function ($rootScope, $state, AuthFactory) {

  $rootScope.$on('$stateChangeStart', function (event, next, current) {
    if (!next.data.restricted) {
      return;
    }

    if (AuthFactory.isLoggedIn()) {
      return;
    }
    AuthFactory.getUserStatus().then(function (user) {
      if (!user) {
        event.preventDefault();
        $state.go('LoginState');
        return;
      } else {
        console.log('ater http request ');
        return;
      }
    });
  });
});

app.factory('AuthFactory', function ($http, $cacheFactory) {

  function extractData(res) {
    _username = res.data.username;
    return res.data.status;
  }
  var _username;
  var currentUser;

  var setCurrentUser = function setCurrentUser(user) {
    if (user) {
      currentUser = true;
    } else {
      currentUser = false;
    }
    return currentUser;
  };

  return {
    login: function login(username, password) {
      return $http.post('/auth/login', { username: username, password: password }).then(extractData).then(setCurrentUser);
    },
    register: function register(username, password) {
      return $http.post('/auth/register', { username: username, password: password }).then(extractData).then(setCurrentUser);
    },
    isLoggedIn: function isLoggedIn() {
      return currentUser;
    },
    username: function username() {
      return _username;
    },
    getUserStatus: function getUserStatus() {
      return $http.get('/auth/status').then(extractData).then(setCurrentUser);
    },
    logout: function logout() {
      return $http.get('/auth/logout').then(extractData).then(setCurrentUser);
    }
  };
});

app.factory('BlogFactory', function ($http, AuthFactory) {
  return {
    createPost: function createPost(post) {
      post.author = AuthFactory.username();
      console.log(post);
      return $http.post('/blog/create', post).then(function (post) {
        return post.data;
      });
    },
    findAllPosts: function findAllPosts() {
      return $http.get('/blog').then(function (allPosts) {
        return allPosts.data;
      });
    }
  };
});

app.directive('navbar', function (AuthFactory, $state) {
  return {
    restrict: 'E',
    templateUrl: '/components/navbar/navbar.html',
    link: function link(scope) {
      scope.loggedIn = function () {
        return AuthFactory.isLoggedIn();
      };

      scope.logout = function () {
        return AuthFactory.logout().then(function () {
          $state.go('LoginState');
        });
      };
    }
  };
});

app.controller('HomeCtrl', function ($scope) {
  //logic here
});

app.config(function ($stateProvider) {
  $stateProvider.state('HomeState', {
    url: '/',
    templateUrl: 'app/js/home/home.html',
    controller: 'HomeCtrl',
    data: {
      restricted: false
    }
  });
});

app.controller('LoginCtrl', function ($scope, AuthFactory, $state) {

  $scope.submitLogin = function () {

    // initial values
    $scope.error = false;
    $scope.disabled = true;

    AuthFactory.login($scope.user.username, $scope.user.password).then(function (data) {
      $state.go('AdminState');
      $scope.disabled = false;
      $scope.user = {};
    }).then(null, function (err) {
      $scope.error = true;
      $scope.errorMessage = "Invalid username and/or password";
      $scope.disabled = false;
      $scope.loginForm = {};
    });
  };
});

app.config(function ($stateProvider) {
  $stateProvider.state('LoginState', {
    url: '/login',
    templateUrl: 'app/js/login/login.html',
    controller: 'LoginCtrl',
    data: {
      restricted: false
    }
  });
});

app.controller('RegisterCtrl', function ($scope, AuthFactory, $state) {

  $scope.register = function () {
    // initial values
    $scope.error = false;
    $scope.disabled = true;

    // call register from service
    AuthFactory.register($scope.registerForm.username, $scope.registerForm.password)
    // handle success
    .then(function () {
      $state.go('LoginState');
      $scope.disabled = false;
      $scope.registerForm = {};
    })
    // handle error
    ['catch'](function () {
      $scope.error = true;
      $scope.errorMessage = "Something went wrong!";
      $scope.disabled = false;
      $scope.registerForm = {};
    });
  };
});

app.config(function ($stateProvider) {
  $stateProvider.state('RegisterState', {
    url: '/register',
    templateUrl: 'app/js/register/register.html',
    controller: 'RegisterCtrl',
    data: {
      restricted: false
    }
  });
});

app.controller('CreateCtrl', function ($scope, BlogFactory, $state) {
  $scope.createPost = function () {
    BlogFactory.createPost($scope.htmlVariable).then(function () {
      $state.go('AdminPosts');
    }).then(function () {
      $scope.htmlVariable = {};
    })['catch'](function (err) {
      console.log(err);
    });
  };
});

app.controller('PostsCtrl', function ($scope, allPosts) {
  $scope.allPosts = allPosts;
});

app.config(function ($stateProvider) {
  //View all posts
  $stateProvider.state('AdminPosts', {
    url: '/admin/posts',
    templateUrl: 'app/js/admin/blog/posts.html',
    controller: 'PostsCtrl',
    data: {
      restricted: true
    },
    resolve: {
      allPosts: function allPosts(BlogFactory) {
        return BlogFactory.findAllPosts().then(function (allPosts) {
          console.log(allPosts);
          return allPosts;
        });
      }
    }
  })
  //Create new Post
  .state('CreateState', {
    url: '/admin/posts/create',
    templateUrl: 'app/js/admin/blog/create.html',
    controller: 'CreateCtrl',
    data: {
      restricted: true
    }
  });
});

app.controller('AdminCtrl', function ($scope, $rootScope) {});

app.config(function ($stateProvider) {
  $stateProvider.state('AdminState', {
    url: '/admin',
    templateUrl: 'app/js/admin/dashboard/dashboard.html',
    controller: 'AdminCtrl',
    data: {
      restricted: true
    }
  });
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImFwcC5qcyIsImF1dGguZmFjdG9yeS5qcyIsImJsb2cuZmFjdG9yeS5qcyIsIm5hdmJhci9uYXZiYXIuZGlyZWN0aXZlLmpzIiwianMvaG9tZS9ob21lLmNvbnRyb2xsZXIuanMiLCJqcy9ob21lL2hvbWUuc3RhdGUuanMiLCJqcy9sb2dpbi9sb2dpbi5jb250cm9sbGVyLmpzIiwianMvbG9naW4vbG9naW4uc3RhdGUuanMiLCJqcy9yZWdpc3Rlci9yZWdpc3Rlci5jb250cm9sbGVyLmpzIiwianMvcmVnaXN0ZXIvcmVnaXN0ZXIuc3RhdGUuanMiLCJqcy9hZG1pbi9ibG9nL2NyZWF0ZS5jb250cm9sbGVyLmpzIiwianMvYWRtaW4vYmxvZy9wb3N0cy5jb250cm9sbGVyLmpzIiwianMvYWRtaW4vYmxvZy9wb3N0cy5zdGF0ZS5qcyIsImpzL2FkbWluL2Rhc2hib2FyZC9kYXNoYm9hcmQuY29udHJvbGxlci5qcyIsImpzL2FkbWluL2Rhc2hib2FyZC9kYXNoYm9hcmQuc3RhdGUuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSxJQUFBLEdBQUEsR0FBQSxPQUFBLENBQUEsTUFBQSxDQUFBLE1BQUEsRUFBQSxDQUFBLFdBQUEsRUFBQSxhQUFBLENBQUEsQ0FBQSxDQUFBOztBQUVBLEdBQUEsQ0FBQSxNQUFBLENBQUEsVUFBQSxrQkFBQSxFQUFBLGlCQUFBLEVBQUE7Ozs7QUFJQSxvQkFBQSxDQUFBLFNBQUEsQ0FBQSxHQUFBLENBQUEsQ0FBQTtDQUVBLENBQUEsQ0FBQTs7QUFFQSxHQUFBLENBQUEsR0FBQSxDQUFBLFVBQUEsVUFBQSxFQUFBLE1BQUEsRUFBQSxXQUFBLEVBQUE7O0FBRUEsWUFBQSxDQUFBLEdBQUEsQ0FBQSxtQkFBQSxFQUFBLFVBQUEsS0FBQSxFQUFBLElBQUEsRUFBQSxPQUFBLEVBQUE7QUFDQSxRQUFBLENBQUEsSUFBQSxDQUFBLElBQUEsQ0FBQSxVQUFBLEVBQUE7QUFDQSxhQUFBO0tBQ0E7O0FBRUEsUUFBQSxXQUFBLENBQUEsVUFBQSxFQUFBLEVBQUE7QUFDQSxhQUFBO0tBQ0E7QUFDQSxlQUFBLENBQUEsYUFBQSxFQUFBLENBQ0EsSUFBQSxDQUFBLFVBQUEsSUFBQSxFQUFBO0FBQ0EsVUFBQSxDQUFBLElBQUEsRUFBQTtBQUNBLGFBQUEsQ0FBQSxjQUFBLEVBQUEsQ0FBQTtBQUNBLGNBQUEsQ0FBQSxFQUFBLENBQUEsWUFBQSxDQUFBLENBQUE7QUFDQSxlQUFBO09BQ0EsTUFBQTtBQUNBLGVBQUEsQ0FBQSxHQUFBLENBQUEsb0JBQUEsQ0FBQSxDQUFBO0FBQ0EsZUFBQTtPQUNBO0tBQ0EsQ0FBQSxDQUFBO0dBQ0EsQ0FBQSxDQUFBO0NBQ0EsQ0FBQSxDQUFBOztBQ2hDQSxHQUFBLENBQUEsT0FBQSxDQUFBLGFBQUEsRUFBQSxVQUFBLEtBQUEsRUFBQSxhQUFBLEVBQUE7O0FBRUEsV0FBQSxXQUFBLENBQUEsR0FBQSxFQUFBO0FBQ0EsYUFBQSxHQUFBLEdBQUEsQ0FBQSxJQUFBLENBQUEsUUFBQSxDQUFBO0FBQ0EsV0FBQSxHQUFBLENBQUEsSUFBQSxDQUFBLE1BQUEsQ0FBQTtHQUNBO0FBQ0EsTUFBQSxTQUFBLENBQUE7QUFDQSxNQUFBLFdBQUEsQ0FBQTs7QUFFQSxNQUFBLGNBQUEsR0FBQSxTQUFBLGNBQUEsQ0FBQSxJQUFBLEVBQUE7QUFDQSxRQUFBLElBQUEsRUFBQTtBQUNBLGlCQUFBLEdBQUEsSUFBQSxDQUFBO0tBQ0EsTUFBQTtBQUNBLGlCQUFBLEdBQUEsS0FBQSxDQUFBO0tBQ0E7QUFDQSxXQUFBLFdBQUEsQ0FBQTtHQUNBLENBQUE7O0FBRUEsU0FBQTtBQUNBLFNBQUEsRUFBQSxlQUFBLFFBQUEsRUFBQSxRQUFBLEVBQUE7QUFDQSxhQUFBLEtBQUEsQ0FBQSxJQUFBLENBQUEsYUFBQSxFQUFBLEVBQUEsUUFBQSxFQUFBLFFBQUEsRUFBQSxRQUFBLEVBQUEsUUFBQSxFQUFBLENBQUEsQ0FDQSxJQUFBLENBQUEsV0FBQSxDQUFBLENBQ0EsSUFBQSxDQUFBLGNBQUEsQ0FBQSxDQUFBO0tBQ0E7QUFDQSxZQUFBLEVBQUEsa0JBQUEsUUFBQSxFQUFBLFFBQUEsRUFBQTtBQUNBLGFBQUEsS0FBQSxDQUFBLElBQUEsQ0FBQSxnQkFBQSxFQUFBLEVBQUEsUUFBQSxFQUFBLFFBQUEsRUFBQSxRQUFBLEVBQUEsUUFBQSxFQUFBLENBQUEsQ0FDQSxJQUFBLENBQUEsV0FBQSxDQUFBLENBQ0EsSUFBQSxDQUFBLGNBQUEsQ0FBQSxDQUFBO0tBQ0E7QUFDQSxjQUFBLEVBQUEsc0JBQUE7QUFDQSxhQUFBLFdBQUEsQ0FBQTtLQUNBO0FBQ0EsWUFBQSxFQUFBLG9CQUFBO0FBQ0EsYUFBQSxTQUFBLENBQUE7S0FDQTtBQUNBLGlCQUFBLEVBQUEseUJBQUE7QUFDQSxhQUFBLEtBQUEsQ0FBQSxHQUFBLENBQUEsY0FBQSxDQUFBLENBQ0EsSUFBQSxDQUFBLFdBQUEsQ0FBQSxDQUNBLElBQUEsQ0FBQSxjQUFBLENBQUEsQ0FBQTtLQUNBO0FBQ0EsVUFBQSxFQUFBLGtCQUFBO0FBQ0EsYUFBQSxLQUFBLENBQUEsR0FBQSxDQUFBLGNBQUEsQ0FBQSxDQUNBLElBQUEsQ0FBQSxXQUFBLENBQUEsQ0FDQSxJQUFBLENBQUEsY0FBQSxDQUFBLENBQUE7S0FDQTtHQUNBLENBQUE7Q0FDQSxDQUFBLENBQUE7O0FDOUNBLEdBQUEsQ0FBQSxPQUFBLENBQUEsYUFBQSxFQUFBLFVBQUEsS0FBQSxFQUFBLFdBQUEsRUFBQTtBQUNBLFNBQUE7QUFDQSxjQUFBLEVBQUEsb0JBQUEsSUFBQSxFQUFBO0FBQ0EsVUFBQSxDQUFBLE1BQUEsR0FBQSxXQUFBLENBQUEsUUFBQSxFQUFBLENBQUE7QUFDQSxhQUFBLENBQUEsR0FBQSxDQUFBLElBQUEsQ0FBQSxDQUFBO0FBQ0EsYUFBQSxLQUFBLENBQUEsSUFBQSxDQUFBLGNBQUEsRUFBQSxJQUFBLENBQUEsQ0FDQSxJQUFBLENBQUEsVUFBQSxJQUFBLEVBQUE7QUFDQSxlQUFBLElBQUEsQ0FBQSxJQUFBLENBQUE7T0FDQSxDQUFBLENBQUE7S0FDQTtBQUNBLGdCQUFBLEVBQUEsd0JBQUE7QUFDQSxhQUFBLEtBQUEsQ0FBQSxHQUFBLENBQUEsT0FBQSxDQUFBLENBQ0EsSUFBQSxDQUFBLFVBQUEsUUFBQSxFQUFBO0FBQ0EsZUFBQSxRQUFBLENBQUEsSUFBQSxDQUFBO09BQ0EsQ0FBQSxDQUFBO0tBQ0E7R0FDQSxDQUFBO0NBQ0EsQ0FBQSxDQUFBOztBQ2pCQSxHQUFBLENBQUEsU0FBQSxDQUFBLFFBQUEsRUFBQSxVQUFBLFdBQUEsRUFBQSxNQUFBLEVBQUE7QUFDQSxTQUFBO0FBQ0EsWUFBQSxFQUFBLEdBQUE7QUFDQSxlQUFBLEVBQUEsZ0NBQUE7QUFDQSxRQUFBLEVBQUEsY0FBQSxLQUFBLEVBQUE7QUFDQSxXQUFBLENBQUEsUUFBQSxHQUFBLFlBQUE7QUFDQSxlQUFBLFdBQUEsQ0FBQSxVQUFBLEVBQUEsQ0FBQTtPQUNBLENBQUE7O0FBRUEsV0FBQSxDQUFBLE1BQUEsR0FBQSxZQUFBO0FBQ0EsZUFBQSxXQUFBLENBQUEsTUFBQSxFQUFBLENBQ0EsSUFBQSxDQUFBLFlBQUE7QUFDQSxnQkFBQSxDQUFBLEVBQUEsQ0FBQSxZQUFBLENBQUEsQ0FBQTtTQUNBLENBQUEsQ0FBQTtPQUNBLENBQUE7S0FDQTtHQUNBLENBQUE7Q0FDQSxDQUFBLENBQUE7O0FDakJBLEdBQUEsQ0FBQSxVQUFBLENBQUEsVUFBQSxFQUFBLFVBQUEsTUFBQSxFQUFBOztDQUVBLENBQUEsQ0FBQTs7QUNGQSxHQUFBLENBQUEsTUFBQSxDQUFBLFVBQUEsY0FBQSxFQUFBO0FBQ0EsZ0JBQUEsQ0FBQSxLQUFBLENBQUEsV0FBQSxFQUFBO0FBQ0EsT0FBQSxFQUFBLEdBQUE7QUFDQSxlQUFBLEVBQUEsdUJBQUE7QUFDQSxjQUFBLEVBQUEsVUFBQTtBQUNBLFFBQUEsRUFBQTtBQUNBLGdCQUFBLEVBQUEsS0FBQTtLQUNBO0dBQ0EsQ0FBQSxDQUFBO0NBQ0EsQ0FBQSxDQUFBOztBQ1RBLEdBQUEsQ0FBQSxVQUFBLENBQUEsV0FBQSxFQUFBLFVBQUEsTUFBQSxFQUFBLFdBQUEsRUFBQSxNQUFBLEVBQUE7O0FBRUEsUUFBQSxDQUFBLFdBQUEsR0FBQSxZQUFBOzs7QUFHQSxVQUFBLENBQUEsS0FBQSxHQUFBLEtBQUEsQ0FBQTtBQUNBLFVBQUEsQ0FBQSxRQUFBLEdBQUEsSUFBQSxDQUFBOztBQUVBLGVBQUEsQ0FBQSxLQUFBLENBQUEsTUFBQSxDQUFBLElBQUEsQ0FBQSxRQUFBLEVBQUEsTUFBQSxDQUFBLElBQUEsQ0FBQSxRQUFBLENBQUEsQ0FDQSxJQUFBLENBQUEsVUFBQSxJQUFBLEVBQUE7QUFDQSxZQUFBLENBQUEsRUFBQSxDQUFBLFlBQUEsQ0FBQSxDQUFBO0FBQ0EsWUFBQSxDQUFBLFFBQUEsR0FBQSxLQUFBLENBQUE7QUFDQSxZQUFBLENBQUEsSUFBQSxHQUFBLEVBQUEsQ0FBQTtLQUNBLENBQUEsQ0FDQSxJQUFBLENBQUEsSUFBQSxFQUFBLFVBQUEsR0FBQSxFQUFBO0FBQ0EsWUFBQSxDQUFBLEtBQUEsR0FBQSxJQUFBLENBQUE7QUFDQSxZQUFBLENBQUEsWUFBQSxHQUFBLGtDQUFBLENBQUE7QUFDQSxZQUFBLENBQUEsUUFBQSxHQUFBLEtBQUEsQ0FBQTtBQUNBLFlBQUEsQ0FBQSxTQUFBLEdBQUEsRUFBQSxDQUFBO0tBQ0EsQ0FBQSxDQUFBO0dBQ0EsQ0FBQTtDQUNBLENBQUEsQ0FBQTs7QUNyQkEsR0FBQSxDQUFBLE1BQUEsQ0FBQSxVQUFBLGNBQUEsRUFBQTtBQUNBLGdCQUFBLENBQUEsS0FBQSxDQUFBLFlBQUEsRUFBQTtBQUNBLE9BQUEsRUFBQSxRQUFBO0FBQ0EsZUFBQSxFQUFBLHlCQUFBO0FBQ0EsY0FBQSxFQUFBLFdBQUE7QUFDQSxRQUFBLEVBQUE7QUFDQSxnQkFBQSxFQUFBLEtBQUE7S0FDQTtHQUNBLENBQUEsQ0FBQTtDQUNBLENBQUEsQ0FBQTs7QUNUQSxHQUFBLENBQUEsVUFBQSxDQUFBLGNBQUEsRUFBQSxVQUFBLE1BQUEsRUFBQSxXQUFBLEVBQUEsTUFBQSxFQUFBOztBQUVBLFFBQUEsQ0FBQSxRQUFBLEdBQUEsWUFBQTs7QUFFQSxVQUFBLENBQUEsS0FBQSxHQUFBLEtBQUEsQ0FBQTtBQUNBLFVBQUEsQ0FBQSxRQUFBLEdBQUEsSUFBQSxDQUFBOzs7QUFHQSxlQUFBLENBQUEsUUFBQSxDQUFBLE1BQUEsQ0FBQSxZQUFBLENBQUEsUUFBQSxFQUFBLE1BQUEsQ0FBQSxZQUFBLENBQUEsUUFBQSxDQUFBOztLQUVBLElBQUEsQ0FBQSxZQUFBO0FBQ0EsWUFBQSxDQUFBLEVBQUEsQ0FBQSxZQUFBLENBQUEsQ0FBQTtBQUNBLFlBQUEsQ0FBQSxRQUFBLEdBQUEsS0FBQSxDQUFBO0FBQ0EsWUFBQSxDQUFBLFlBQUEsR0FBQSxFQUFBLENBQUE7S0FDQSxDQUFBOzthQUVBLENBQUEsWUFBQTtBQUNBLFlBQUEsQ0FBQSxLQUFBLEdBQUEsSUFBQSxDQUFBO0FBQ0EsWUFBQSxDQUFBLFlBQUEsR0FBQSx1QkFBQSxDQUFBO0FBQ0EsWUFBQSxDQUFBLFFBQUEsR0FBQSxLQUFBLENBQUE7QUFDQSxZQUFBLENBQUEsWUFBQSxHQUFBLEVBQUEsQ0FBQTtLQUNBLENBQUEsQ0FBQTtHQUNBLENBQUE7Q0FFQSxDQUFBLENBQUE7O0FDeEJBLEdBQUEsQ0FBQSxNQUFBLENBQUEsVUFBQSxjQUFBLEVBQUE7QUFDQSxnQkFBQSxDQUFBLEtBQUEsQ0FBQSxlQUFBLEVBQUE7QUFDQSxPQUFBLEVBQUEsV0FBQTtBQUNBLGVBQUEsRUFBQSwrQkFBQTtBQUNBLGNBQUEsRUFBQSxjQUFBO0FBQ0EsUUFBQSxFQUFBO0FBQ0EsZ0JBQUEsRUFBQSxLQUFBO0tBQ0E7R0FDQSxDQUFBLENBQUE7Q0FDQSxDQUFBLENBQUE7O0FDVEEsR0FBQSxDQUFBLFVBQUEsQ0FBQSxZQUFBLEVBQUEsVUFBQSxNQUFBLEVBQUEsV0FBQSxFQUFBLE1BQUEsRUFBQTtBQUNBLFFBQUEsQ0FBQSxVQUFBLEdBQUEsWUFBQTtBQUNBLGVBQUEsQ0FBQSxVQUFBLENBQUEsTUFBQSxDQUFBLFlBQUEsQ0FBQSxDQUNBLElBQUEsQ0FBQSxZQUFBO0FBQ0EsWUFBQSxDQUFBLEVBQUEsQ0FBQSxZQUFBLENBQUEsQ0FBQTtLQUNBLENBQUEsQ0FDQSxJQUFBLENBQUEsWUFBQTtBQUNBLFlBQUEsQ0FBQSxZQUFBLEdBQUEsRUFBQSxDQUFBO0tBQ0EsQ0FBQSxTQUNBLENBQUEsVUFBQSxHQUFBLEVBQUE7QUFDQSxhQUFBLENBQUEsR0FBQSxDQUFBLEdBQUEsQ0FBQSxDQUFBO0tBQ0EsQ0FBQSxDQUFBO0dBQ0EsQ0FBQTtDQUVBLENBQUEsQ0FBQTs7QUNkQSxHQUFBLENBQUEsVUFBQSxDQUFBLFdBQUEsRUFBQSxVQUFBLE1BQUEsRUFBQSxRQUFBLEVBQUE7QUFDQSxRQUFBLENBQUEsUUFBQSxHQUFBLFFBQUEsQ0FBQTtDQUNBLENBQUEsQ0FBQTs7QUNGQSxHQUFBLENBQUEsTUFBQSxDQUFBLFVBQUEsY0FBQSxFQUFBOztBQUVBLGdCQUFBLENBQUEsS0FBQSxDQUFBLFlBQUEsRUFBQTtBQUNBLE9BQUEsRUFBQSxjQUFBO0FBQ0EsZUFBQSxFQUFBLDhCQUFBO0FBQ0EsY0FBQSxFQUFBLFdBQUE7QUFDQSxRQUFBLEVBQUE7QUFDQSxnQkFBQSxFQUFBLElBQUE7S0FDQTtBQUNBLFdBQUEsRUFBQTtBQUNBLGNBQUEsRUFBQSxrQkFBQSxXQUFBLEVBQUE7QUFDQSxlQUFBLFdBQUEsQ0FBQSxZQUFBLEVBQUEsQ0FDQSxJQUFBLENBQUEsVUFBQSxRQUFBLEVBQUE7QUFDQSxpQkFBQSxDQUFBLEdBQUEsQ0FBQSxRQUFBLENBQUEsQ0FBQTtBQUNBLGlCQUFBLFFBQUEsQ0FBQTtTQUNBLENBQUEsQ0FBQTtPQUNBO0tBQ0E7R0FDQSxDQUFBOztHQUVBLEtBQUEsQ0FBQSxhQUFBLEVBQUE7QUFDQSxPQUFBLEVBQUEscUJBQUE7QUFDQSxlQUFBLEVBQUEsK0JBQUE7QUFDQSxjQUFBLEVBQUEsWUFBQTtBQUNBLFFBQUEsRUFBQTtBQUNBLGdCQUFBLEVBQUEsSUFBQTtLQUNBO0dBQ0EsQ0FBQSxDQUFBO0NBQ0EsQ0FBQSxDQUFBOztBQzVCQSxHQUFBLENBQUEsVUFBQSxDQUFBLFdBQUEsRUFBQSxVQUFBLE1BQUEsRUFBQSxVQUFBLEVBQUEsRUFFQSxDQUFBLENBQUE7O0FDRkEsR0FBQSxDQUFBLE1BQUEsQ0FBQSxVQUFBLGNBQUEsRUFBQTtBQUNBLGdCQUFBLENBQUEsS0FBQSxDQUFBLFlBQUEsRUFBQTtBQUNBLE9BQUEsRUFBQSxRQUFBO0FBQ0EsZUFBQSxFQUFBLHVDQUFBO0FBQ0EsY0FBQSxFQUFBLFdBQUE7QUFDQSxRQUFBLEVBQUE7QUFDQSxnQkFBQSxFQUFBLElBQUE7S0FDQTtHQUNBLENBQUEsQ0FBQTtDQUNBLENBQUEsQ0FBQSIsImZpbGUiOiJtYWluLmpzIiwic291cmNlc0NvbnRlbnQiOlsidmFyIGFwcCA9IGFuZ3VsYXIubW9kdWxlKCdtYWluJywgWyd1aS5yb3V0ZXInLCAndGV4dEFuZ3VsYXInXSk7XG5cbmFwcC5jb25maWcoZnVuY3Rpb24oJHVybFJvdXRlclByb3ZpZGVyLCAkbG9jYXRpb25Qcm92aWRlcil7XG5cdC8vIFRoaXMgdHVybnMgb2ZmIGhhc2hiYW5nIHVybHMgKC8jYWJvdXQpIGFuZCBjaGFuZ2VzIGl0IHRvIHNvbWV0aGluZyBub3JtYWwgKC9hYm91dClcblx0Ly8gJGxvY2F0aW9uUHJvdmlkZXIuaHRtbDVNb2RlKHRydWUpO1xuXHQvLyBJZiB3ZSBnbyB0byBhIFVSTCB0aGF0IHVpLXJvdXRlciBkb2Vzbid0IGhhdmUgcmVnaXN0ZXJlZCwgZ28gdG8gdGhlIFwiL1wiIHVybC5cbiAgJHVybFJvdXRlclByb3ZpZGVyLm90aGVyd2lzZSgnLycpO1xuXG59KVxuXG5hcHAucnVuKGZ1bmN0aW9uICgkcm9vdFNjb3BlLCAkc3RhdGUsIEF1dGhGYWN0b3J5KSB7XG5cbiAgJHJvb3RTY29wZS4kb24oJyRzdGF0ZUNoYW5nZVN0YXJ0JywgZnVuY3Rpb24gKGV2ZW50LCBuZXh0LCBjdXJyZW50KSB7XG4gICAgaWYoIW5leHQuZGF0YS5yZXN0cmljdGVkKXtcbiAgICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGlmKEF1dGhGYWN0b3J5LmlzTG9nZ2VkSW4oKSl7XG4gICAgICAgIHJldHVybjtcbiAgICB9XG4gICAgQXV0aEZhY3RvcnkuZ2V0VXNlclN0YXR1cygpXG4gICAgLnRoZW4oZnVuY3Rpb24odXNlcil7XG4gICAgICBpZiAoIXVzZXIpIHtcbiAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKVxuICAgICAgICAkc3RhdGUuZ28oJ0xvZ2luU3RhdGUnKTtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfWVsc2V7XG4gICAgICAgIGNvbnNvbGUubG9nKCdhdGVyIGh0dHAgcmVxdWVzdCAnKVxuICAgICAgICByZXR1cm47XG4gICAgICB9XG4gICAgfSlcbiAgfSk7XG59KTtcbiIsImFwcC5mYWN0b3J5KCdBdXRoRmFjdG9yeScsIGZ1bmN0aW9uKCRodHRwLCAkY2FjaGVGYWN0b3J5KSB7XG5cbiAgZnVuY3Rpb24gZXh0cmFjdERhdGEocmVzKXtcbiAgICB1c2VybmFtZSA9IHJlcy5kYXRhLnVzZXJuYW1lO1xuICAgIHJldHVybiByZXMuZGF0YS5zdGF0dXNcbiAgfVxuICB2YXIgdXNlcm5hbWU7XG4gIHZhciBjdXJyZW50VXNlcjtcblxuICB2YXIgc2V0Q3VycmVudFVzZXIgPSBmdW5jdGlvbih1c2VyKXtcbiAgICBpZih1c2VyKXtcbiAgICAgIGN1cnJlbnRVc2VyID0gdHJ1ZTtcbiAgICB9ZWxzZXtcbiAgICAgIGN1cnJlbnRVc2VyID0gZmFsc2U7XG4gICAgfVxuICAgIHJldHVybiBjdXJyZW50VXNlclxuICB9XG5cbiAgcmV0dXJuIHtcbiAgICBsb2dpbjogZnVuY3Rpb24odXNlcm5hbWUsIHBhc3N3b3JkKXtcbiAgICAgIHJldHVybiAkaHR0cC5wb3N0KCcvYXV0aC9sb2dpbicsIHt1c2VybmFtZTogdXNlcm5hbWUsIHBhc3N3b3JkOiBwYXNzd29yZH0pXG4gICAgICAudGhlbihleHRyYWN0RGF0YSlcbiAgICAgIC50aGVuKHNldEN1cnJlbnRVc2VyKVxuICAgIH0sXG4gICAgcmVnaXN0ZXI6IGZ1bmN0aW9uKHVzZXJuYW1lLCBwYXNzd29yZCl7XG4gICAgICByZXR1cm4gJGh0dHAucG9zdCgnL2F1dGgvcmVnaXN0ZXInLCB7dXNlcm5hbWU6IHVzZXJuYW1lLCBwYXNzd29yZDogcGFzc3dvcmR9KVxuICAgICAgLnRoZW4oZXh0cmFjdERhdGEpXG4gICAgICAudGhlbihzZXRDdXJyZW50VXNlcilcbiAgICB9LFxuICAgIGlzTG9nZ2VkSW46IGZ1bmN0aW9uKCkge1xuICAgICAgcmV0dXJuIGN1cnJlbnRVc2VyXG4gICAgfSxcbiAgICB1c2VybmFtZTogZnVuY3Rpb24oKXtcbiAgICAgIHJldHVybiB1c2VybmFtZTtcbiAgICB9LFxuICAgIGdldFVzZXJTdGF0dXM6IGZ1bmN0aW9uKCl7XG4gICAgICByZXR1cm4gJGh0dHAuZ2V0KCcvYXV0aC9zdGF0dXMnKVxuICAgICAgLnRoZW4oZXh0cmFjdERhdGEpXG4gICAgICAudGhlbihzZXRDdXJyZW50VXNlcilcbiAgICB9LFxuICAgIGxvZ291dDogZnVuY3Rpb24oKXtcbiAgICAgIHJldHVybiAkaHR0cC5nZXQoJy9hdXRoL2xvZ291dCcpXG4gICAgICAudGhlbihleHRyYWN0RGF0YSlcbiAgICAgIC50aGVuKHNldEN1cnJlbnRVc2VyKVxuICAgIH1cbiAgfVxufSlcbiIsImFwcC5mYWN0b3J5KCdCbG9nRmFjdG9yeScsZnVuY3Rpb24oJGh0dHAsIEF1dGhGYWN0b3J5KXtcblx0cmV0dXJuIHtcblx0XHRjcmVhdGVQb3N0OiBmdW5jdGlvbihwb3N0KXtcblx0XHRcdHBvc3QuYXV0aG9yID0gQXV0aEZhY3RvcnkudXNlcm5hbWUoKTtcblx0XHRcdGNvbnNvbGUubG9nKHBvc3QpXG5cdFx0XHRyZXR1cm4gJGh0dHAucG9zdCgnL2Jsb2cvY3JlYXRlJywgcG9zdClcbiAgICAgIC50aGVuKGZ1bmN0aW9uKHBvc3Qpe1xuICAgICAgICByZXR1cm4gcG9zdC5kYXRhXG4gICAgICB9KVxuXHRcdH0sXG5cdFx0ZmluZEFsbFBvc3RzOiBmdW5jdGlvbigpe1xuXHRcdFx0cmV0dXJuICRodHRwLmdldCgnL2Jsb2cnKVxuXHRcdFx0LnRoZW4oZnVuY3Rpb24oYWxsUG9zdHMpe1xuXHRcdFx0XHRyZXR1cm4gYWxsUG9zdHMuZGF0YVxuXHRcdFx0fSlcblx0XHR9XG4gIH1cbn0pXG4iLCJhcHAuZGlyZWN0aXZlKCduYXZiYXInLCBmdW5jdGlvbihBdXRoRmFjdG9yeSwgJHN0YXRlKXtcblx0cmV0dXJuIHtcblx0XHRyZXN0cmljdDogJ0UnLFxuXHRcdHRlbXBsYXRlVXJsOiAnL2NvbXBvbmVudHMvbmF2YmFyL25hdmJhci5odG1sJyxcblx0XHRsaW5rOiBmdW5jdGlvbihzY29wZSl7XG5cdFx0XHRzY29wZS5sb2dnZWRJbiA9IGZ1bmN0aW9uKCl7XG5cdFx0XHRcdHJldHVybiBBdXRoRmFjdG9yeS5pc0xvZ2dlZEluKCk7XG5cdFx0XHR9O1xuXG5cdFx0XHRzY29wZS5sb2dvdXQgPSBmdW5jdGlvbigpe1xuXHRcdFx0XHRyZXR1cm4gQXV0aEZhY3RvcnkubG9nb3V0KClcblx0XHRcdFx0LnRoZW4oZnVuY3Rpb24oKXtcblx0XHRcdFx0XHQkc3RhdGUuZ28oJ0xvZ2luU3RhdGUnKVxuXHRcdFx0XHR9KVxuXHRcdFx0fVxuXHRcdH1cblx0fVxufSlcbiIsImFwcC5jb250cm9sbGVyKCdIb21lQ3RybCcsIGZ1bmN0aW9uKCRzY29wZSl7XG4gIC8vbG9naWMgaGVyZVxufSk7XG4iLCJhcHAuY29uZmlnKGZ1bmN0aW9uICgkc3RhdGVQcm92aWRlcikge1xuXHQkc3RhdGVQcm92aWRlci5zdGF0ZSgnSG9tZVN0YXRlJywge1xuXHRcdHVybDogJy8nLFxuXHRcdHRlbXBsYXRlVXJsOiAnYXBwL2pzL2hvbWUvaG9tZS5odG1sJyxcbiAgICBjb250cm9sbGVyOiAnSG9tZUN0cmwnLFxuXHRcdGRhdGE6IHtcblx0XHRcdHJlc3RyaWN0ZWQ6IGZhbHNlXG5cdFx0fVxuXHR9KTtcbn0pO1xuIiwiYXBwLmNvbnRyb2xsZXIoJ0xvZ2luQ3RybCcsIGZ1bmN0aW9uKCRzY29wZSwgQXV0aEZhY3RvcnksICRzdGF0ZSkge1xuXG4gICRzY29wZS5zdWJtaXRMb2dpbiA9IGZ1bmN0aW9uKCkge1xuXG4gICAgLy8gaW5pdGlhbCB2YWx1ZXNcbiAgICAkc2NvcGUuZXJyb3IgPSBmYWxzZTtcbiAgICAkc2NvcGUuZGlzYWJsZWQgPSB0cnVlO1xuXG4gICAgQXV0aEZhY3RvcnkubG9naW4oJHNjb3BlLnVzZXIudXNlcm5hbWUsICRzY29wZS51c2VyLnBhc3N3b3JkKVxuICAgICAgLnRoZW4oZnVuY3Rpb24oZGF0YSkge1xuICAgICAgICAgICRzdGF0ZS5nbygnQWRtaW5TdGF0ZScpXG4gICAgICAgICAgJHNjb3BlLmRpc2FibGVkID0gZmFsc2U7XG4gICAgICAgICAgJHNjb3BlLnVzZXIgPSB7fTtcbiAgICAgIH0pXG4gICAgICAudGhlbihudWxsLCBmdW5jdGlvbihlcnIpIHtcbiAgICAgICAgJHNjb3BlLmVycm9yID0gdHJ1ZTtcbiAgICAgICAgJHNjb3BlLmVycm9yTWVzc2FnZSA9IFwiSW52YWxpZCB1c2VybmFtZSBhbmQvb3IgcGFzc3dvcmRcIjtcbiAgICAgICAgJHNjb3BlLmRpc2FibGVkID0gZmFsc2U7XG4gICAgICAgICRzY29wZS5sb2dpbkZvcm0gPSB7fTtcbiAgICAgIH0pXG4gIH1cbn0pO1xuIiwiYXBwLmNvbmZpZyhmdW5jdGlvbiAoJHN0YXRlUHJvdmlkZXIpIHtcblx0JHN0YXRlUHJvdmlkZXIuc3RhdGUoJ0xvZ2luU3RhdGUnLCB7XG5cdFx0dXJsOiAnL2xvZ2luJyxcblx0XHR0ZW1wbGF0ZVVybDogJ2FwcC9qcy9sb2dpbi9sb2dpbi5odG1sJyxcbiAgICBjb250cm9sbGVyOiAnTG9naW5DdHJsJyxcblx0XHRkYXRhOiB7XG5cdFx0XHRyZXN0cmljdGVkOiBmYWxzZVxuXHRcdH1cblx0fSk7XG59KTtcbiIsImFwcC5jb250cm9sbGVyKCdSZWdpc3RlckN0cmwnLCBmdW5jdGlvbigkc2NvcGUsIEF1dGhGYWN0b3J5LCAkc3RhdGUpIHtcblxuICAkc2NvcGUucmVnaXN0ZXIgPSBmdW5jdGlvbigpIHtcbiAgICAvLyBpbml0aWFsIHZhbHVlc1xuICAgICRzY29wZS5lcnJvciA9IGZhbHNlO1xuICAgICRzY29wZS5kaXNhYmxlZCA9IHRydWU7XG5cbiAgICAvLyBjYWxsIHJlZ2lzdGVyIGZyb20gc2VydmljZVxuICAgIEF1dGhGYWN0b3J5LnJlZ2lzdGVyKCRzY29wZS5yZWdpc3RlckZvcm0udXNlcm5hbWUsICRzY29wZS5yZWdpc3RlckZvcm0ucGFzc3dvcmQpXG4gICAgICAvLyBoYW5kbGUgc3VjY2Vzc1xuICAgICAgLnRoZW4oZnVuY3Rpb24oKSB7XG4gICAgICAgICRzdGF0ZS5nbygnTG9naW5TdGF0ZScpXG4gICAgICAgICRzY29wZS5kaXNhYmxlZCA9IGZhbHNlO1xuICAgICAgICAkc2NvcGUucmVnaXN0ZXJGb3JtID0ge307XG4gICAgICB9KVxuICAgICAgLy8gaGFuZGxlIGVycm9yXG4gICAgICAuY2F0Y2goZnVuY3Rpb24oKSB7XG4gICAgICAgICRzY29wZS5lcnJvciA9IHRydWU7XG4gICAgICAgICRzY29wZS5lcnJvck1lc3NhZ2UgPSBcIlNvbWV0aGluZyB3ZW50IHdyb25nIVwiO1xuICAgICAgICAkc2NvcGUuZGlzYWJsZWQgPSBmYWxzZTtcbiAgICAgICAgJHNjb3BlLnJlZ2lzdGVyRm9ybSA9IHt9O1xuICAgICAgfSk7XG4gIH07XG5cbn0pO1xuIiwiYXBwLmNvbmZpZyhmdW5jdGlvbiAoJHN0YXRlUHJvdmlkZXIpIHtcblx0JHN0YXRlUHJvdmlkZXIuc3RhdGUoJ1JlZ2lzdGVyU3RhdGUnLCB7XG5cdFx0dXJsOiAnL3JlZ2lzdGVyJyxcblx0XHR0ZW1wbGF0ZVVybDogJ2FwcC9qcy9yZWdpc3Rlci9yZWdpc3Rlci5odG1sJyxcbiAgICBjb250cm9sbGVyOiAnUmVnaXN0ZXJDdHJsJyxcblx0XHRkYXRhOiB7XG5cdFx0XHRyZXN0cmljdGVkOiBmYWxzZVxuXHRcdH1cblx0fSk7XG59KTtcbiIsImFwcC5jb250cm9sbGVyKCdDcmVhdGVDdHJsJywgZnVuY3Rpb24oJHNjb3BlLCBCbG9nRmFjdG9yeSwgJHN0YXRlKXtcbiAgJHNjb3BlLmNyZWF0ZVBvc3QgPSBmdW5jdGlvbigpe1xuICAgICAgQmxvZ0ZhY3RvcnkuY3JlYXRlUG9zdCgkc2NvcGUuaHRtbFZhcmlhYmxlKVxuICAgICAgLnRoZW4oZnVuY3Rpb24oKXtcbiAgICAgICAgJHN0YXRlLmdvKCdBZG1pblBvc3RzJylcbiAgICAgIH0pXG4gICAgICAudGhlbihmdW5jdGlvbigpe1xuICAgICAgICAkc2NvcGUuaHRtbFZhcmlhYmxlID0ge307XG4gICAgICB9KVxuICAgICAgLmNhdGNoKGZ1bmN0aW9uKGVycil7XG4gICAgICAgIGNvbnNvbGUubG9nKGVycik7XG4gICAgICB9KVxuICB9XG5cbn0pO1xuIiwiYXBwLmNvbnRyb2xsZXIoJ1Bvc3RzQ3RybCcsIGZ1bmN0aW9uKCRzY29wZSwgYWxsUG9zdHMpe1xuICAkc2NvcGUuYWxsUG9zdHMgPSBhbGxQb3N0cztcbn0pO1xuIiwiYXBwLmNvbmZpZyhmdW5jdGlvbigkc3RhdGVQcm92aWRlcikge1xuXHQvL1ZpZXcgYWxsIHBvc3RzXG4gICRzdGF0ZVByb3ZpZGVyLnN0YXRlKCdBZG1pblBvc3RzJywge1xuICAgICAgdXJsOiAnL2FkbWluL3Bvc3RzJyxcbiAgICAgIHRlbXBsYXRlVXJsOiAnYXBwL2pzL2FkbWluL2Jsb2cvcG9zdHMuaHRtbCcsXG4gICAgICBjb250cm9sbGVyOiAnUG9zdHNDdHJsJyxcbiAgICAgIGRhdGE6IHtcbiAgICAgICAgcmVzdHJpY3RlZDogdHJ1ZVxuICAgICAgfSxcbiAgICAgIHJlc29sdmU6IHtcbiAgICAgICAgYWxsUG9zdHM6IGZ1bmN0aW9uKEJsb2dGYWN0b3J5KSB7XG4gICAgICAgICAgcmV0dXJuIEJsb2dGYWN0b3J5LmZpbmRBbGxQb3N0cygpXG4gICAgICAgICAgICAudGhlbihmdW5jdGlvbihhbGxQb3N0cykge1xuICAgICAgICAgICAgICBjb25zb2xlLmxvZyhhbGxQb3N0cylcbiAgICAgICAgICAgICAgcmV0dXJuIGFsbFBvc3RzXG4gICAgICAgICAgICB9KVxuICAgICAgICB9XG4gICAgICB9XG4gICAgfSlcblx0XHQvL0NyZWF0ZSBuZXcgUG9zdFxuICAgIC5zdGF0ZSgnQ3JlYXRlU3RhdGUnLCB7XG4gICAgICB1cmw6ICcvYWRtaW4vcG9zdHMvY3JlYXRlJyxcbiAgICAgIHRlbXBsYXRlVXJsOiAnYXBwL2pzL2FkbWluL2Jsb2cvY3JlYXRlLmh0bWwnLFxuICAgICAgY29udHJvbGxlcjogJ0NyZWF0ZUN0cmwnLFxuICAgICAgZGF0YToge1xuICAgICAgICByZXN0cmljdGVkOiB0cnVlXG4gICAgICB9XG4gICAgfSlcbn0pO1xuIiwiYXBwLmNvbnRyb2xsZXIoJ0FkbWluQ3RybCcsIGZ1bmN0aW9uKCRzY29wZSwgJHJvb3RTY29wZSl7XG5cbn0pO1xuIiwiYXBwLmNvbmZpZyhmdW5jdGlvbiAoJHN0YXRlUHJvdmlkZXIpIHtcblx0JHN0YXRlUHJvdmlkZXIuc3RhdGUoJ0FkbWluU3RhdGUnLCB7XG5cdFx0dXJsOiAnL2FkbWluJyxcblx0XHR0ZW1wbGF0ZVVybDogJ2FwcC9qcy9hZG1pbi9kYXNoYm9hcmQvZGFzaGJvYXJkLmh0bWwnLFxuICAgIGNvbnRyb2xsZXI6ICdBZG1pbkN0cmwnLFxuXHRcdGRhdGE6IHtcblx0XHRcdHJlc3RyaWN0ZWQ6IHRydWVcblx0XHR9XG5cdH0pXG59KTtcbiJdLCJzb3VyY2VSb290IjoiL3NvdXJjZS8ifQ==
