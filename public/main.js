'use strict';

var app = angular.module('main', ['ui.router', 'textAngular']);

app.config(function ($urlRouterProvider, $locationProvider) {
  // This turns off hashbang urls (/#about) and changes it to something normal (/about)
  // $locationProvider.html5Mode(true);
  // If we go to a URL that ui-router doesn't have registered, go to the "/" url.
  $urlRouterProvider.otherwise('/');
});

app.run(function ($rootScope, $state, AuthFactory) {

  $rootScope.$on('$stateChangeStart', function (event, next, current) {
    if (!next.data.restricted) {
      return;
    }

    if (AuthFactory.isLoggedIn()) {
      console.log('logged in');
      return;
    }
    AuthFactory.getUserStatus().then(function (user) {
      if (!user) {
        event.preventDefault();
        $state.go('LoginState');
        return;
      } else {
        console.log('ater http request ');
        return;
      }
    });
  });
});

app.factory('AuthFactory', function ($http, $cacheFactory) {

  function extractData(res) {
    return res.data.status;
  }

  var currentUser;

  var setCurrentUser = function setCurrentUser(user) {
    if (user) {
      currentUser = true;
    } else {
      currentUser = false;
    }
    return currentUser;
  };

  return {
    login: function login(username, password) {
      return $http.post('/auth/login', { username: username, password: password }).then(extractData).then(setCurrentUser);
    },
    register: function register(username, password) {
      return $http.post('/auth/register', { username: username, password: password }).then(extractData).then(setCurrentUser);
    },
    isLoggedIn: function isLoggedIn() {
      return currentUser;
    },
    getUserStatus: function getUserStatus() {
      return $http.get('/auth/status').then(extractData).then(setCurrentUser);
    },
    logout: function logout() {
      return $http.get('/auth/logout').then(extractData).then(setCurrentUser);
    }
  };
});

app.factory('BlogFactory', function ($http, AuthFactory) {
  return {
    createPost: function createPost(post) {
      return $http.post('/blog/create', post).then(function (post) {
        return post.data;
      });
    },
    findAllPosts: function findAllPosts() {
      return $http.get('/blog').then(function (allPosts) {
        return allPosts.data;
      });
    }
  };
});

app.directive('navbar', function (AuthFactory, $state) {
  return {
    restrict: 'E',
    templateUrl: '/components/navbar/navbar.html',
    link: function link(scope) {
      scope.loggedIn = function () {
        return AuthFactory.isLoggedIn();
      };

      scope.logout = function () {
        return AuthFactory.logout().then(function () {
          $state.go('LoginState');
        });
      };
    }
  };
});

app.controller('HomeCtrl', function ($scope) {
  //logic here
});

app.config(function ($stateProvider) {
  $stateProvider.state('HomeState', {
    url: '/',
    templateUrl: 'app/js/home/home.html',
    controller: 'HomeCtrl',
    data: {
      restricted: false
    }
  });
});

app.controller('LoginCtrl', function ($scope, AuthFactory, $state) {

  $scope.submitLogin = function () {

    // initial values
    $scope.error = false;
    $scope.disabled = true;

    AuthFactory.login($scope.user.username, $scope.user.password).then(function (data) {
      $state.go('AdminState');
      $scope.disabled = false;
      $scope.user = {};
    }).then(null, function (err) {
      $scope.error = true;
      $scope.errorMessage = "Invalid username and/or password";
      $scope.disabled = false;
      $scope.loginForm = {};
    });
  };
});

app.config(function ($stateProvider) {
  $stateProvider.state('LoginState', {
    url: '/login',
    templateUrl: 'app/js/login/login.html',
    controller: 'LoginCtrl',
    data: {
      restricted: false
    }
  });
});

app.controller('RegisterCtrl', function ($scope, AuthFactory, $state) {

  $scope.register = function () {
    // initial values
    $scope.error = false;
    $scope.disabled = true;

    // call register from service
    AuthFactory.register($scope.registerForm.username, $scope.registerForm.password)
    // handle success
    .then(function () {
      $state.go('LoginState');
      $scope.disabled = false;
      $scope.registerForm = {};
    })
    // handle error
    ['catch'](function () {
      $scope.error = true;
      $scope.errorMessage = "Something went wrong!";
      $scope.disabled = false;
      $scope.registerForm = {};
    });
  };
});

app.config(function ($stateProvider) {
  $stateProvider.state('RegisterState', {
    url: '/register',
    templateUrl: 'app/js/register/register.html',
    controller: 'RegisterCtrl',
    data: {
      restricted: false
    }
  });
});

app.controller('CreateCtrl', function ($scope, BlogFactory, $state) {

  $scope.createPost = function () {
    BlogFactory.createPost($scope.htmlVariable).then(function () {
      $state.go('AdminPosts');
    }).then(function () {
      $scope.htmlVariable = {};
    })['catch'](function (err) {
      console.log(err);
    });
  };
});

app.controller('PostsCtrl', function ($scope, allPosts) {
  $scope.allPosts = allPosts;
});

app.config(function ($stateProvider) {
  //View all posts
  $stateProvider.state('AdminPosts', {
    url: '/admin/posts',
    templateUrl: 'app/js/admin/blog/posts.html',
    controller: 'PostsCtrl',
    data: {
      restricted: true
    },
    resolve: {
      allPosts: function allPosts(BlogFactory) {
        return BlogFactory.findAllPosts().then(function (allPosts) {
          console.log(allPosts);
          return allPosts;
        });
      }
    }
  })
  //Create new Post
  .state('CreateState', {
    url: '/admin/posts/create',
    templateUrl: 'app/js/admin/blog/create.html',
    controller: 'CreateCtrl',
    data: {
      restricted: true
    }
  });
});

app.controller('AdminCtrl', function ($scope, $rootScope) {});

app.config(function ($stateProvider) {
  $stateProvider.state('AdminState', {
    url: '/admin',
    templateUrl: 'app/js/admin/dashboard/dashboard.html',
    controller: 'AdminCtrl',
    data: {
      restricted: true
    }
  });
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImFwcC5qcyIsImF1dGguZmFjdG9yeS5qcyIsImJsb2cuZmFjdG9yeS5qcyIsIm5hdmJhci9uYXZiYXIuZGlyZWN0aXZlLmpzIiwianMvaG9tZS9ob21lLmNvbnRyb2xsZXIuanMiLCJqcy9ob21lL2hvbWUuc3RhdGUuanMiLCJqcy9sb2dpbi9sb2dpbi5jb250cm9sbGVyLmpzIiwianMvbG9naW4vbG9naW4uc3RhdGUuanMiLCJqcy9yZWdpc3Rlci9yZWdpc3Rlci5jb250cm9sbGVyLmpzIiwianMvcmVnaXN0ZXIvcmVnaXN0ZXIuc3RhdGUuanMiLCJqcy9hZG1pbi9ibG9nL2NyZWF0ZS5jb250cm9sbGVyLmpzIiwianMvYWRtaW4vYmxvZy9wb3N0cy5jb250cm9sbGVyLmpzIiwianMvYWRtaW4vYmxvZy9wb3N0cy5zdGF0ZS5qcyIsImpzL2FkbWluL2Rhc2hib2FyZC9kYXNoYm9hcmQuY29udHJvbGxlci5qcyIsImpzL2FkbWluL2Rhc2hib2FyZC9kYXNoYm9hcmQuc3RhdGUuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSxJQUFBLEdBQUEsR0FBQSxPQUFBLENBQUEsTUFBQSxDQUFBLE1BQUEsRUFBQSxDQUFBLFdBQUEsRUFBQSxhQUFBLENBQUEsQ0FBQSxDQUFBOztBQUVBLEdBQUEsQ0FBQSxNQUFBLENBQUEsVUFBQSxrQkFBQSxFQUFBLGlCQUFBLEVBQUE7Ozs7QUFJQSxvQkFBQSxDQUFBLFNBQUEsQ0FBQSxHQUFBLENBQUEsQ0FBQTtDQUVBLENBQUEsQ0FBQTs7QUFFQSxHQUFBLENBQUEsR0FBQSxDQUFBLFVBQUEsVUFBQSxFQUFBLE1BQUEsRUFBQSxXQUFBLEVBQUE7O0FBRUEsWUFBQSxDQUFBLEdBQUEsQ0FBQSxtQkFBQSxFQUFBLFVBQUEsS0FBQSxFQUFBLElBQUEsRUFBQSxPQUFBLEVBQUE7QUFDQSxRQUFBLENBQUEsSUFBQSxDQUFBLElBQUEsQ0FBQSxVQUFBLEVBQUE7QUFDQSxhQUFBO0tBQ0E7O0FBRUEsUUFBQSxXQUFBLENBQUEsVUFBQSxFQUFBLEVBQUE7QUFDQSxhQUFBLENBQUEsR0FBQSxDQUFBLFdBQUEsQ0FBQSxDQUFBO0FBQ0EsYUFBQTtLQUNBO0FBQ0EsZUFBQSxDQUFBLGFBQUEsRUFBQSxDQUNBLElBQUEsQ0FBQSxVQUFBLElBQUEsRUFBQTtBQUNBLFVBQUEsQ0FBQSxJQUFBLEVBQUE7QUFDQSxhQUFBLENBQUEsY0FBQSxFQUFBLENBQUE7QUFDQSxjQUFBLENBQUEsRUFBQSxDQUFBLFlBQUEsQ0FBQSxDQUFBO0FBQ0EsZUFBQTtPQUNBLE1BQUE7QUFDQSxlQUFBLENBQUEsR0FBQSxDQUFBLG9CQUFBLENBQUEsQ0FBQTtBQUNBLGVBQUE7T0FDQTtLQUNBLENBQUEsQ0FBQTtHQUNBLENBQUEsQ0FBQTtDQUNBLENBQUEsQ0FBQTs7QUNqQ0EsR0FBQSxDQUFBLE9BQUEsQ0FBQSxhQUFBLEVBQUEsVUFBQSxLQUFBLEVBQUEsYUFBQSxFQUFBOztBQUVBLFdBQUEsV0FBQSxDQUFBLEdBQUEsRUFBQTtBQUNBLFdBQUEsR0FBQSxDQUFBLElBQUEsQ0FBQSxNQUFBLENBQUE7R0FDQTs7QUFFQSxNQUFBLFdBQUEsQ0FBQTs7QUFFQSxNQUFBLGNBQUEsR0FBQSxTQUFBLGNBQUEsQ0FBQSxJQUFBLEVBQUE7QUFDQSxRQUFBLElBQUEsRUFBQTtBQUNBLGlCQUFBLEdBQUEsSUFBQSxDQUFBO0tBQ0EsTUFBQTtBQUNBLGlCQUFBLEdBQUEsS0FBQSxDQUFBO0tBQ0E7QUFDQSxXQUFBLFdBQUEsQ0FBQTtHQUNBLENBQUE7O0FBRUEsU0FBQTtBQUNBLFNBQUEsRUFBQSxlQUFBLFFBQUEsRUFBQSxRQUFBLEVBQUE7QUFDQSxhQUFBLEtBQUEsQ0FBQSxJQUFBLENBQUEsYUFBQSxFQUFBLEVBQUEsUUFBQSxFQUFBLFFBQUEsRUFBQSxRQUFBLEVBQUEsUUFBQSxFQUFBLENBQUEsQ0FDQSxJQUFBLENBQUEsV0FBQSxDQUFBLENBQ0EsSUFBQSxDQUFBLGNBQUEsQ0FBQSxDQUFBO0tBQ0E7QUFDQSxZQUFBLEVBQUEsa0JBQUEsUUFBQSxFQUFBLFFBQUEsRUFBQTtBQUNBLGFBQUEsS0FBQSxDQUFBLElBQUEsQ0FBQSxnQkFBQSxFQUFBLEVBQUEsUUFBQSxFQUFBLFFBQUEsRUFBQSxRQUFBLEVBQUEsUUFBQSxFQUFBLENBQUEsQ0FDQSxJQUFBLENBQUEsV0FBQSxDQUFBLENBQ0EsSUFBQSxDQUFBLGNBQUEsQ0FBQSxDQUFBO0tBQ0E7QUFDQSxjQUFBLEVBQUEsc0JBQUE7QUFDQSxhQUFBLFdBQUEsQ0FBQTtLQUNBO0FBQ0EsaUJBQUEsRUFBQSx5QkFBQTtBQUNBLGFBQUEsS0FBQSxDQUFBLEdBQUEsQ0FBQSxjQUFBLENBQUEsQ0FDQSxJQUFBLENBQUEsV0FBQSxDQUFBLENBQ0EsSUFBQSxDQUFBLGNBQUEsQ0FBQSxDQUFBO0tBQ0E7QUFDQSxVQUFBLEVBQUEsa0JBQUE7QUFDQSxhQUFBLEtBQUEsQ0FBQSxHQUFBLENBQUEsY0FBQSxDQUFBLENBQ0EsSUFBQSxDQUFBLFdBQUEsQ0FBQSxDQUNBLElBQUEsQ0FBQSxjQUFBLENBQUEsQ0FBQTtLQUNBO0dBQ0EsQ0FBQTtDQUNBLENBQUEsQ0FBQTs7QUMxQ0EsR0FBQSxDQUFBLE9BQUEsQ0FBQSxhQUFBLEVBQUEsVUFBQSxLQUFBLEVBQUEsV0FBQSxFQUFBO0FBQ0EsU0FBQTtBQUNBLGNBQUEsRUFBQSxvQkFBQSxJQUFBLEVBQUE7QUFDQSxhQUFBLEtBQUEsQ0FBQSxJQUFBLENBQUEsY0FBQSxFQUFBLElBQUEsQ0FBQSxDQUNBLElBQUEsQ0FBQSxVQUFBLElBQUEsRUFBQTtBQUNBLGVBQUEsSUFBQSxDQUFBLElBQUEsQ0FBQTtPQUNBLENBQUEsQ0FBQTtLQUNBO0FBQ0EsZ0JBQUEsRUFBQSx3QkFBQTtBQUNBLGFBQUEsS0FBQSxDQUFBLEdBQUEsQ0FBQSxPQUFBLENBQUEsQ0FDQSxJQUFBLENBQUEsVUFBQSxRQUFBLEVBQUE7QUFDQSxlQUFBLFFBQUEsQ0FBQSxJQUFBLENBQUE7T0FDQSxDQUFBLENBQUE7S0FDQTtHQUNBLENBQUE7Q0FDQSxDQUFBLENBQUE7O0FDZkEsR0FBQSxDQUFBLFNBQUEsQ0FBQSxRQUFBLEVBQUEsVUFBQSxXQUFBLEVBQUEsTUFBQSxFQUFBO0FBQ0EsU0FBQTtBQUNBLFlBQUEsRUFBQSxHQUFBO0FBQ0EsZUFBQSxFQUFBLGdDQUFBO0FBQ0EsUUFBQSxFQUFBLGNBQUEsS0FBQSxFQUFBO0FBQ0EsV0FBQSxDQUFBLFFBQUEsR0FBQSxZQUFBO0FBQ0EsZUFBQSxXQUFBLENBQUEsVUFBQSxFQUFBLENBQUE7T0FDQSxDQUFBOztBQUVBLFdBQUEsQ0FBQSxNQUFBLEdBQUEsWUFBQTtBQUNBLGVBQUEsV0FBQSxDQUFBLE1BQUEsRUFBQSxDQUNBLElBQUEsQ0FBQSxZQUFBO0FBQ0EsZ0JBQUEsQ0FBQSxFQUFBLENBQUEsWUFBQSxDQUFBLENBQUE7U0FDQSxDQUFBLENBQUE7T0FDQSxDQUFBO0tBQ0E7R0FDQSxDQUFBO0NBQ0EsQ0FBQSxDQUFBOztBQ2pCQSxHQUFBLENBQUEsVUFBQSxDQUFBLFVBQUEsRUFBQSxVQUFBLE1BQUEsRUFBQTs7Q0FFQSxDQUFBLENBQUE7O0FDRkEsR0FBQSxDQUFBLE1BQUEsQ0FBQSxVQUFBLGNBQUEsRUFBQTtBQUNBLGdCQUFBLENBQUEsS0FBQSxDQUFBLFdBQUEsRUFBQTtBQUNBLE9BQUEsRUFBQSxHQUFBO0FBQ0EsZUFBQSxFQUFBLHVCQUFBO0FBQ0EsY0FBQSxFQUFBLFVBQUE7QUFDQSxRQUFBLEVBQUE7QUFDQSxnQkFBQSxFQUFBLEtBQUE7S0FDQTtHQUNBLENBQUEsQ0FBQTtDQUNBLENBQUEsQ0FBQTs7QUNUQSxHQUFBLENBQUEsVUFBQSxDQUFBLFdBQUEsRUFBQSxVQUFBLE1BQUEsRUFBQSxXQUFBLEVBQUEsTUFBQSxFQUFBOztBQUVBLFFBQUEsQ0FBQSxXQUFBLEdBQUEsWUFBQTs7O0FBR0EsVUFBQSxDQUFBLEtBQUEsR0FBQSxLQUFBLENBQUE7QUFDQSxVQUFBLENBQUEsUUFBQSxHQUFBLElBQUEsQ0FBQTs7QUFFQSxlQUFBLENBQUEsS0FBQSxDQUFBLE1BQUEsQ0FBQSxJQUFBLENBQUEsUUFBQSxFQUFBLE1BQUEsQ0FBQSxJQUFBLENBQUEsUUFBQSxDQUFBLENBQ0EsSUFBQSxDQUFBLFVBQUEsSUFBQSxFQUFBO0FBQ0EsWUFBQSxDQUFBLEVBQUEsQ0FBQSxZQUFBLENBQUEsQ0FBQTtBQUNBLFlBQUEsQ0FBQSxRQUFBLEdBQUEsS0FBQSxDQUFBO0FBQ0EsWUFBQSxDQUFBLElBQUEsR0FBQSxFQUFBLENBQUE7S0FDQSxDQUFBLENBQ0EsSUFBQSxDQUFBLElBQUEsRUFBQSxVQUFBLEdBQUEsRUFBQTtBQUNBLFlBQUEsQ0FBQSxLQUFBLEdBQUEsSUFBQSxDQUFBO0FBQ0EsWUFBQSxDQUFBLFlBQUEsR0FBQSxrQ0FBQSxDQUFBO0FBQ0EsWUFBQSxDQUFBLFFBQUEsR0FBQSxLQUFBLENBQUE7QUFDQSxZQUFBLENBQUEsU0FBQSxHQUFBLEVBQUEsQ0FBQTtLQUNBLENBQUEsQ0FBQTtHQUNBLENBQUE7Q0FDQSxDQUFBLENBQUE7O0FDckJBLEdBQUEsQ0FBQSxNQUFBLENBQUEsVUFBQSxjQUFBLEVBQUE7QUFDQSxnQkFBQSxDQUFBLEtBQUEsQ0FBQSxZQUFBLEVBQUE7QUFDQSxPQUFBLEVBQUEsUUFBQTtBQUNBLGVBQUEsRUFBQSx5QkFBQTtBQUNBLGNBQUEsRUFBQSxXQUFBO0FBQ0EsUUFBQSxFQUFBO0FBQ0EsZ0JBQUEsRUFBQSxLQUFBO0tBQ0E7R0FDQSxDQUFBLENBQUE7Q0FDQSxDQUFBLENBQUE7O0FDVEEsR0FBQSxDQUFBLFVBQUEsQ0FBQSxjQUFBLEVBQUEsVUFBQSxNQUFBLEVBQUEsV0FBQSxFQUFBLE1BQUEsRUFBQTs7QUFFQSxRQUFBLENBQUEsUUFBQSxHQUFBLFlBQUE7O0FBRUEsVUFBQSxDQUFBLEtBQUEsR0FBQSxLQUFBLENBQUE7QUFDQSxVQUFBLENBQUEsUUFBQSxHQUFBLElBQUEsQ0FBQTs7O0FBR0EsZUFBQSxDQUFBLFFBQUEsQ0FBQSxNQUFBLENBQUEsWUFBQSxDQUFBLFFBQUEsRUFBQSxNQUFBLENBQUEsWUFBQSxDQUFBLFFBQUEsQ0FBQTs7S0FFQSxJQUFBLENBQUEsWUFBQTtBQUNBLFlBQUEsQ0FBQSxFQUFBLENBQUEsWUFBQSxDQUFBLENBQUE7QUFDQSxZQUFBLENBQUEsUUFBQSxHQUFBLEtBQUEsQ0FBQTtBQUNBLFlBQUEsQ0FBQSxZQUFBLEdBQUEsRUFBQSxDQUFBO0tBQ0EsQ0FBQTs7YUFFQSxDQUFBLFlBQUE7QUFDQSxZQUFBLENBQUEsS0FBQSxHQUFBLElBQUEsQ0FBQTtBQUNBLFlBQUEsQ0FBQSxZQUFBLEdBQUEsdUJBQUEsQ0FBQTtBQUNBLFlBQUEsQ0FBQSxRQUFBLEdBQUEsS0FBQSxDQUFBO0FBQ0EsWUFBQSxDQUFBLFlBQUEsR0FBQSxFQUFBLENBQUE7S0FDQSxDQUFBLENBQUE7R0FDQSxDQUFBO0NBRUEsQ0FBQSxDQUFBOztBQ3hCQSxHQUFBLENBQUEsTUFBQSxDQUFBLFVBQUEsY0FBQSxFQUFBO0FBQ0EsZ0JBQUEsQ0FBQSxLQUFBLENBQUEsZUFBQSxFQUFBO0FBQ0EsT0FBQSxFQUFBLFdBQUE7QUFDQSxlQUFBLEVBQUEsK0JBQUE7QUFDQSxjQUFBLEVBQUEsY0FBQTtBQUNBLFFBQUEsRUFBQTtBQUNBLGdCQUFBLEVBQUEsS0FBQTtLQUNBO0dBQ0EsQ0FBQSxDQUFBO0NBQ0EsQ0FBQSxDQUFBOztBQ1RBLEdBQUEsQ0FBQSxVQUFBLENBQUEsWUFBQSxFQUFBLFVBQUEsTUFBQSxFQUFBLFdBQUEsRUFBQSxNQUFBLEVBQUE7O0FBRUEsUUFBQSxDQUFBLFVBQUEsR0FBQSxZQUFBO0FBQ0EsZUFBQSxDQUFBLFVBQUEsQ0FBQSxNQUFBLENBQUEsWUFBQSxDQUFBLENBQ0EsSUFBQSxDQUFBLFlBQUE7QUFDQSxZQUFBLENBQUEsRUFBQSxDQUFBLFlBQUEsQ0FBQSxDQUFBO0tBQ0EsQ0FBQSxDQUNBLElBQUEsQ0FBQSxZQUFBO0FBQ0EsWUFBQSxDQUFBLFlBQUEsR0FBQSxFQUFBLENBQUE7S0FDQSxDQUFBLFNBQ0EsQ0FBQSxVQUFBLEdBQUEsRUFBQTtBQUNBLGFBQUEsQ0FBQSxHQUFBLENBQUEsR0FBQSxDQUFBLENBQUE7S0FDQSxDQUFBLENBQUE7R0FDQSxDQUFBO0NBRUEsQ0FBQSxDQUFBOztBQ2ZBLEdBQUEsQ0FBQSxVQUFBLENBQUEsV0FBQSxFQUFBLFVBQUEsTUFBQSxFQUFBLFFBQUEsRUFBQTtBQUNBLFFBQUEsQ0FBQSxRQUFBLEdBQUEsUUFBQSxDQUFBO0NBQ0EsQ0FBQSxDQUFBOztBQ0ZBLEdBQUEsQ0FBQSxNQUFBLENBQUEsVUFBQSxjQUFBLEVBQUE7O0FBRUEsZ0JBQUEsQ0FBQSxLQUFBLENBQUEsWUFBQSxFQUFBO0FBQ0EsT0FBQSxFQUFBLGNBQUE7QUFDQSxlQUFBLEVBQUEsOEJBQUE7QUFDQSxjQUFBLEVBQUEsV0FBQTtBQUNBLFFBQUEsRUFBQTtBQUNBLGdCQUFBLEVBQUEsSUFBQTtLQUNBO0FBQ0EsV0FBQSxFQUFBO0FBQ0EsY0FBQSxFQUFBLGtCQUFBLFdBQUEsRUFBQTtBQUNBLGVBQUEsV0FBQSxDQUFBLFlBQUEsRUFBQSxDQUNBLElBQUEsQ0FBQSxVQUFBLFFBQUEsRUFBQTtBQUNBLGlCQUFBLENBQUEsR0FBQSxDQUFBLFFBQUEsQ0FBQSxDQUFBO0FBQ0EsaUJBQUEsUUFBQSxDQUFBO1NBQ0EsQ0FBQSxDQUFBO09BQ0E7S0FDQTtHQUNBLENBQUE7O0dBRUEsS0FBQSxDQUFBLGFBQUEsRUFBQTtBQUNBLE9BQUEsRUFBQSxxQkFBQTtBQUNBLGVBQUEsRUFBQSwrQkFBQTtBQUNBLGNBQUEsRUFBQSxZQUFBO0FBQ0EsUUFBQSxFQUFBO0FBQ0EsZ0JBQUEsRUFBQSxJQUFBO0tBQ0E7R0FDQSxDQUFBLENBQUE7Q0FDQSxDQUFBLENBQUE7O0FDNUJBLEdBQUEsQ0FBQSxVQUFBLENBQUEsV0FBQSxFQUFBLFVBQUEsTUFBQSxFQUFBLFVBQUEsRUFBQSxFQUVBLENBQUEsQ0FBQTs7QUNGQSxHQUFBLENBQUEsTUFBQSxDQUFBLFVBQUEsY0FBQSxFQUFBO0FBQ0EsZ0JBQUEsQ0FBQSxLQUFBLENBQUEsWUFBQSxFQUFBO0FBQ0EsT0FBQSxFQUFBLFFBQUE7QUFDQSxlQUFBLEVBQUEsdUNBQUE7QUFDQSxjQUFBLEVBQUEsV0FBQTtBQUNBLFFBQUEsRUFBQTtBQUNBLGdCQUFBLEVBQUEsSUFBQTtLQUNBO0dBQ0EsQ0FBQSxDQUFBO0NBQ0EsQ0FBQSxDQUFBIiwiZmlsZSI6Im1haW4uanMiLCJzb3VyY2VzQ29udGVudCI6WyJ2YXIgYXBwID0gYW5ndWxhci5tb2R1bGUoJ21haW4nLCBbJ3VpLnJvdXRlcicsICd0ZXh0QW5ndWxhciddKTtcblxuYXBwLmNvbmZpZyhmdW5jdGlvbigkdXJsUm91dGVyUHJvdmlkZXIsICRsb2NhdGlvblByb3ZpZGVyKXtcblx0Ly8gVGhpcyB0dXJucyBvZmYgaGFzaGJhbmcgdXJscyAoLyNhYm91dCkgYW5kIGNoYW5nZXMgaXQgdG8gc29tZXRoaW5nIG5vcm1hbCAoL2Fib3V0KVxuXHQvLyAkbG9jYXRpb25Qcm92aWRlci5odG1sNU1vZGUodHJ1ZSk7XG5cdC8vIElmIHdlIGdvIHRvIGEgVVJMIHRoYXQgdWktcm91dGVyIGRvZXNuJ3QgaGF2ZSByZWdpc3RlcmVkLCBnbyB0byB0aGUgXCIvXCIgdXJsLlxuICAkdXJsUm91dGVyUHJvdmlkZXIub3RoZXJ3aXNlKCcvJyk7XG5cbn0pXG5cbmFwcC5ydW4oZnVuY3Rpb24gKCRyb290U2NvcGUsICRzdGF0ZSwgQXV0aEZhY3RvcnkpIHtcblxuICAkcm9vdFNjb3BlLiRvbignJHN0YXRlQ2hhbmdlU3RhcnQnLCBmdW5jdGlvbiAoZXZlbnQsIG5leHQsIGN1cnJlbnQpIHtcbiAgICBpZighbmV4dC5kYXRhLnJlc3RyaWN0ZWQpe1xuICAgICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgaWYoQXV0aEZhY3RvcnkuaXNMb2dnZWRJbigpKXtcbiAgICAgIGNvbnNvbGUubG9nKCdsb2dnZWQgaW4nKVxuICAgICAgICByZXR1cm47XG4gICAgfVxuICAgIEF1dGhGYWN0b3J5LmdldFVzZXJTdGF0dXMoKVxuICAgIC50aGVuKGZ1bmN0aW9uKHVzZXIpe1xuICAgICAgaWYgKCF1c2VyKSB7XG4gICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KClcbiAgICAgICAgJHN0YXRlLmdvKCdMb2dpblN0YXRlJyk7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1lbHNle1xuICAgICAgICBjb25zb2xlLmxvZygnYXRlciBodHRwIHJlcXVlc3QgJylcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuICAgIH0pXG4gIH0pO1xufSk7XG4iLCJhcHAuZmFjdG9yeSgnQXV0aEZhY3RvcnknLCBmdW5jdGlvbigkaHR0cCwgJGNhY2hlRmFjdG9yeSkge1xuXG4gIGZ1bmN0aW9uIGV4dHJhY3REYXRhKHJlcyl7XG4gICAgcmV0dXJuIHJlcy5kYXRhLnN0YXR1c1xuICB9XG5cbiAgdmFyIGN1cnJlbnRVc2VyO1xuXG4gIHZhciBzZXRDdXJyZW50VXNlciA9IGZ1bmN0aW9uKHVzZXIpe1xuICAgIGlmKHVzZXIpe1xuICAgICAgY3VycmVudFVzZXIgPSB0cnVlO1xuICAgIH1lbHNle1xuICAgICAgY3VycmVudFVzZXIgPSBmYWxzZTtcbiAgICB9XG4gICAgcmV0dXJuIGN1cnJlbnRVc2VyXG4gIH1cblxuICByZXR1cm4ge1xuICAgIGxvZ2luOiBmdW5jdGlvbih1c2VybmFtZSwgcGFzc3dvcmQpe1xuICAgICAgcmV0dXJuICRodHRwLnBvc3QoJy9hdXRoL2xvZ2luJywge3VzZXJuYW1lOiB1c2VybmFtZSwgcGFzc3dvcmQ6IHBhc3N3b3JkfSlcbiAgICAgIC50aGVuKGV4dHJhY3REYXRhKVxuICAgICAgLnRoZW4oc2V0Q3VycmVudFVzZXIpXG4gICAgfSxcbiAgICByZWdpc3RlcjogZnVuY3Rpb24odXNlcm5hbWUsIHBhc3N3b3JkKXtcbiAgICAgIHJldHVybiAkaHR0cC5wb3N0KCcvYXV0aC9yZWdpc3RlcicsIHt1c2VybmFtZTogdXNlcm5hbWUsIHBhc3N3b3JkOiBwYXNzd29yZH0pXG4gICAgICAudGhlbihleHRyYWN0RGF0YSlcbiAgICAgIC50aGVuKHNldEN1cnJlbnRVc2VyKVxuICAgIH0sXG4gICAgaXNMb2dnZWRJbjogZnVuY3Rpb24oKSB7XG4gICAgICByZXR1cm4gY3VycmVudFVzZXJcbiAgICB9LFxuICAgIGdldFVzZXJTdGF0dXM6IGZ1bmN0aW9uKCl7XG4gICAgICByZXR1cm4gJGh0dHAuZ2V0KCcvYXV0aC9zdGF0dXMnKVxuICAgICAgLnRoZW4oZXh0cmFjdERhdGEpXG4gICAgICAudGhlbihzZXRDdXJyZW50VXNlcilcbiAgICB9LFxuICAgIGxvZ291dDogZnVuY3Rpb24oKXtcbiAgICAgIHJldHVybiAkaHR0cC5nZXQoJy9hdXRoL2xvZ291dCcpXG4gICAgICAudGhlbihleHRyYWN0RGF0YSlcbiAgICAgIC50aGVuKHNldEN1cnJlbnRVc2VyKVxuICAgIH1cbiAgfVxufSlcbiIsImFwcC5mYWN0b3J5KCdCbG9nRmFjdG9yeScsZnVuY3Rpb24oJGh0dHAsIEF1dGhGYWN0b3J5KXtcblx0cmV0dXJuIHtcblx0XHRjcmVhdGVQb3N0OiBmdW5jdGlvbihwb3N0KXtcblx0XHRcdHJldHVybiAkaHR0cC5wb3N0KCcvYmxvZy9jcmVhdGUnLCBwb3N0KVxuICAgICAgLnRoZW4oZnVuY3Rpb24ocG9zdCl7XG4gICAgICAgIHJldHVybiBwb3N0LmRhdGFcbiAgICAgIH0pXG5cdFx0fSxcblx0XHRmaW5kQWxsUG9zdHM6IGZ1bmN0aW9uKCl7XG5cdFx0XHRyZXR1cm4gJGh0dHAuZ2V0KCcvYmxvZycpXG5cdFx0XHQudGhlbihmdW5jdGlvbihhbGxQb3N0cyl7XG5cdFx0XHRcdHJldHVybiBhbGxQb3N0cy5kYXRhXG5cdFx0XHR9KVxuXHRcdH1cbiAgfVxufSlcbiIsImFwcC5kaXJlY3RpdmUoJ25hdmJhcicsIGZ1bmN0aW9uKEF1dGhGYWN0b3J5LCAkc3RhdGUpe1xuXHRyZXR1cm4ge1xuXHRcdHJlc3RyaWN0OiAnRScsXG5cdFx0dGVtcGxhdGVVcmw6ICcvY29tcG9uZW50cy9uYXZiYXIvbmF2YmFyLmh0bWwnLFxuXHRcdGxpbms6IGZ1bmN0aW9uKHNjb3BlKXtcblx0XHRcdHNjb3BlLmxvZ2dlZEluID0gZnVuY3Rpb24oKXtcblx0XHRcdFx0cmV0dXJuIEF1dGhGYWN0b3J5LmlzTG9nZ2VkSW4oKTtcblx0XHRcdH07XG5cblx0XHRcdHNjb3BlLmxvZ291dCA9IGZ1bmN0aW9uKCl7XG5cdFx0XHRcdHJldHVybiBBdXRoRmFjdG9yeS5sb2dvdXQoKVxuXHRcdFx0XHQudGhlbihmdW5jdGlvbigpe1xuXHRcdFx0XHRcdCRzdGF0ZS5nbygnTG9naW5TdGF0ZScpXG5cdFx0XHRcdH0pXG5cdFx0XHR9XG5cdFx0fVxuXHR9XG59KVxuIiwiYXBwLmNvbnRyb2xsZXIoJ0hvbWVDdHJsJywgZnVuY3Rpb24oJHNjb3BlKXtcbiAgLy9sb2dpYyBoZXJlXG59KTtcbiIsImFwcC5jb25maWcoZnVuY3Rpb24gKCRzdGF0ZVByb3ZpZGVyKSB7XG5cdCRzdGF0ZVByb3ZpZGVyLnN0YXRlKCdIb21lU3RhdGUnLCB7XG5cdFx0dXJsOiAnLycsXG5cdFx0dGVtcGxhdGVVcmw6ICdhcHAvanMvaG9tZS9ob21lLmh0bWwnLFxuICAgIGNvbnRyb2xsZXI6ICdIb21lQ3RybCcsXG5cdFx0ZGF0YToge1xuXHRcdFx0cmVzdHJpY3RlZDogZmFsc2Vcblx0XHR9XG5cdH0pO1xufSk7XG4iLCJhcHAuY29udHJvbGxlcignTG9naW5DdHJsJywgZnVuY3Rpb24oJHNjb3BlLCBBdXRoRmFjdG9yeSwgJHN0YXRlKSB7XG5cbiAgJHNjb3BlLnN1Ym1pdExvZ2luID0gZnVuY3Rpb24oKSB7XG5cbiAgICAvLyBpbml0aWFsIHZhbHVlc1xuICAgICRzY29wZS5lcnJvciA9IGZhbHNlO1xuICAgICRzY29wZS5kaXNhYmxlZCA9IHRydWU7XG5cbiAgICBBdXRoRmFjdG9yeS5sb2dpbigkc2NvcGUudXNlci51c2VybmFtZSwgJHNjb3BlLnVzZXIucGFzc3dvcmQpXG4gICAgICAudGhlbihmdW5jdGlvbihkYXRhKSB7XG4gICAgICAgICAgJHN0YXRlLmdvKCdBZG1pblN0YXRlJylcbiAgICAgICAgICAkc2NvcGUuZGlzYWJsZWQgPSBmYWxzZTtcbiAgICAgICAgICAkc2NvcGUudXNlciA9IHt9O1xuICAgICAgfSlcbiAgICAgIC50aGVuKG51bGwsIGZ1bmN0aW9uKGVycikge1xuICAgICAgICAkc2NvcGUuZXJyb3IgPSB0cnVlO1xuICAgICAgICAkc2NvcGUuZXJyb3JNZXNzYWdlID0gXCJJbnZhbGlkIHVzZXJuYW1lIGFuZC9vciBwYXNzd29yZFwiO1xuICAgICAgICAkc2NvcGUuZGlzYWJsZWQgPSBmYWxzZTtcbiAgICAgICAgJHNjb3BlLmxvZ2luRm9ybSA9IHt9O1xuICAgICAgfSlcbiAgfVxufSk7XG4iLCJhcHAuY29uZmlnKGZ1bmN0aW9uICgkc3RhdGVQcm92aWRlcikge1xuXHQkc3RhdGVQcm92aWRlci5zdGF0ZSgnTG9naW5TdGF0ZScsIHtcblx0XHR1cmw6ICcvbG9naW4nLFxuXHRcdHRlbXBsYXRlVXJsOiAnYXBwL2pzL2xvZ2luL2xvZ2luLmh0bWwnLFxuICAgIGNvbnRyb2xsZXI6ICdMb2dpbkN0cmwnLFxuXHRcdGRhdGE6IHtcblx0XHRcdHJlc3RyaWN0ZWQ6IGZhbHNlXG5cdFx0fVxuXHR9KTtcbn0pO1xuIiwiYXBwLmNvbnRyb2xsZXIoJ1JlZ2lzdGVyQ3RybCcsIGZ1bmN0aW9uKCRzY29wZSwgQXV0aEZhY3RvcnksICRzdGF0ZSkge1xuXG4gICRzY29wZS5yZWdpc3RlciA9IGZ1bmN0aW9uKCkge1xuICAgIC8vIGluaXRpYWwgdmFsdWVzXG4gICAgJHNjb3BlLmVycm9yID0gZmFsc2U7XG4gICAgJHNjb3BlLmRpc2FibGVkID0gdHJ1ZTtcblxuICAgIC8vIGNhbGwgcmVnaXN0ZXIgZnJvbSBzZXJ2aWNlXG4gICAgQXV0aEZhY3RvcnkucmVnaXN0ZXIoJHNjb3BlLnJlZ2lzdGVyRm9ybS51c2VybmFtZSwgJHNjb3BlLnJlZ2lzdGVyRm9ybS5wYXNzd29yZClcbiAgICAgIC8vIGhhbmRsZSBzdWNjZXNzXG4gICAgICAudGhlbihmdW5jdGlvbigpIHtcbiAgICAgICAgJHN0YXRlLmdvKCdMb2dpblN0YXRlJylcbiAgICAgICAgJHNjb3BlLmRpc2FibGVkID0gZmFsc2U7XG4gICAgICAgICRzY29wZS5yZWdpc3RlckZvcm0gPSB7fTtcbiAgICAgIH0pXG4gICAgICAvLyBoYW5kbGUgZXJyb3JcbiAgICAgIC5jYXRjaChmdW5jdGlvbigpIHtcbiAgICAgICAgJHNjb3BlLmVycm9yID0gdHJ1ZTtcbiAgICAgICAgJHNjb3BlLmVycm9yTWVzc2FnZSA9IFwiU29tZXRoaW5nIHdlbnQgd3JvbmchXCI7XG4gICAgICAgICRzY29wZS5kaXNhYmxlZCA9IGZhbHNlO1xuICAgICAgICAkc2NvcGUucmVnaXN0ZXJGb3JtID0ge307XG4gICAgICB9KTtcbiAgfTtcblxufSk7XG4iLCJhcHAuY29uZmlnKGZ1bmN0aW9uICgkc3RhdGVQcm92aWRlcikge1xuXHQkc3RhdGVQcm92aWRlci5zdGF0ZSgnUmVnaXN0ZXJTdGF0ZScsIHtcblx0XHR1cmw6ICcvcmVnaXN0ZXInLFxuXHRcdHRlbXBsYXRlVXJsOiAnYXBwL2pzL3JlZ2lzdGVyL3JlZ2lzdGVyLmh0bWwnLFxuICAgIGNvbnRyb2xsZXI6ICdSZWdpc3RlckN0cmwnLFxuXHRcdGRhdGE6IHtcblx0XHRcdHJlc3RyaWN0ZWQ6IGZhbHNlXG5cdFx0fVxuXHR9KTtcbn0pO1xuIiwiYXBwLmNvbnRyb2xsZXIoJ0NyZWF0ZUN0cmwnLCBmdW5jdGlvbigkc2NvcGUsIEJsb2dGYWN0b3J5LCAkc3RhdGUpe1xuICBcbiAgJHNjb3BlLmNyZWF0ZVBvc3QgPSBmdW5jdGlvbigpe1xuICAgICAgQmxvZ0ZhY3RvcnkuY3JlYXRlUG9zdCgkc2NvcGUuaHRtbFZhcmlhYmxlKVxuICAgICAgLnRoZW4oZnVuY3Rpb24oKXtcbiAgICAgICAgJHN0YXRlLmdvKCdBZG1pblBvc3RzJylcbiAgICAgIH0pXG4gICAgICAudGhlbihmdW5jdGlvbigpe1xuICAgICAgICAkc2NvcGUuaHRtbFZhcmlhYmxlID0ge307XG4gICAgICB9KVxuICAgICAgLmNhdGNoKGZ1bmN0aW9uKGVycil7XG4gICAgICAgIGNvbnNvbGUubG9nKGVycik7XG4gICAgICB9KVxuICB9XG5cbn0pO1xuIiwiYXBwLmNvbnRyb2xsZXIoJ1Bvc3RzQ3RybCcsIGZ1bmN0aW9uKCRzY29wZSwgYWxsUG9zdHMpe1xuICAkc2NvcGUuYWxsUG9zdHMgPSBhbGxQb3N0cztcbn0pO1xuIiwiYXBwLmNvbmZpZyhmdW5jdGlvbigkc3RhdGVQcm92aWRlcikge1xuXHQvL1ZpZXcgYWxsIHBvc3RzXG4gICRzdGF0ZVByb3ZpZGVyLnN0YXRlKCdBZG1pblBvc3RzJywge1xuICAgICAgdXJsOiAnL2FkbWluL3Bvc3RzJyxcbiAgICAgIHRlbXBsYXRlVXJsOiAnYXBwL2pzL2FkbWluL2Jsb2cvcG9zdHMuaHRtbCcsXG4gICAgICBjb250cm9sbGVyOiAnUG9zdHNDdHJsJyxcbiAgICAgIGRhdGE6IHtcbiAgICAgICAgcmVzdHJpY3RlZDogdHJ1ZVxuICAgICAgfSxcbiAgICAgIHJlc29sdmU6IHtcbiAgICAgICAgYWxsUG9zdHM6IGZ1bmN0aW9uKEJsb2dGYWN0b3J5KSB7XG4gICAgICAgICAgcmV0dXJuIEJsb2dGYWN0b3J5LmZpbmRBbGxQb3N0cygpXG4gICAgICAgICAgICAudGhlbihmdW5jdGlvbihhbGxQb3N0cykge1xuICAgICAgICAgICAgICBjb25zb2xlLmxvZyhhbGxQb3N0cylcbiAgICAgICAgICAgICAgcmV0dXJuIGFsbFBvc3RzXG4gICAgICAgICAgICB9KVxuICAgICAgICB9XG4gICAgICB9XG4gICAgfSlcblx0XHQvL0NyZWF0ZSBuZXcgUG9zdFxuICAgIC5zdGF0ZSgnQ3JlYXRlU3RhdGUnLCB7XG4gICAgICB1cmw6ICcvYWRtaW4vcG9zdHMvY3JlYXRlJyxcbiAgICAgIHRlbXBsYXRlVXJsOiAnYXBwL2pzL2FkbWluL2Jsb2cvY3JlYXRlLmh0bWwnLFxuICAgICAgY29udHJvbGxlcjogJ0NyZWF0ZUN0cmwnLFxuICAgICAgZGF0YToge1xuICAgICAgICByZXN0cmljdGVkOiB0cnVlXG4gICAgICB9XG4gICAgfSlcbn0pO1xuIiwiYXBwLmNvbnRyb2xsZXIoJ0FkbWluQ3RybCcsIGZ1bmN0aW9uKCRzY29wZSwgJHJvb3RTY29wZSl7XG5cbn0pO1xuIiwiYXBwLmNvbmZpZyhmdW5jdGlvbiAoJHN0YXRlUHJvdmlkZXIpIHtcblx0JHN0YXRlUHJvdmlkZXIuc3RhdGUoJ0FkbWluU3RhdGUnLCB7XG5cdFx0dXJsOiAnL2FkbWluJyxcblx0XHR0ZW1wbGF0ZVVybDogJ2FwcC9qcy9hZG1pbi9kYXNoYm9hcmQvZGFzaGJvYXJkLmh0bWwnLFxuICAgIGNvbnRyb2xsZXI6ICdBZG1pbkN0cmwnLFxuXHRcdGRhdGE6IHtcblx0XHRcdHJlc3RyaWN0ZWQ6IHRydWVcblx0XHR9XG5cdH0pXG59KTtcbiJdLCJzb3VyY2VSb290IjoiL3NvdXJjZS8ifQ==
